<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Watchdog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Replaced the old Cognito SDK with the new oidc-client-ts library from a CDN -->
    <script src="https://unpkg.com/oidc-client-ts@2.2.0/dist/browser/oidc-client-ts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        pre {
            white-space: pre-wrap;
            word-break: break-all;
            background-color: #1f2937;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Simplified Auth Container -->
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 text-center bg-gray-800 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6">Website Watchdog</h2>
        <p class="mb-6 text-gray-400">Please sign in to continue to your dashboard.</p>
        <button id="signIn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-300">Sign In</button>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden max-w-4xl mx-auto mt-10 p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Dashboard</h1>
            <button id="signOut" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Logout</button>
        </div>

        <!-- User Info Display -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">User Session Information</h2>
            <div>Hello: <span id="email" class="font-mono text-green-400"></span></div>
            <div class="mt-4">
                <label class="text-sm text-gray-400">ID Token:</label>
                <pre id="id-token"></pre>
            </div>
        </div>

        <!-- Add Website Form -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Monitor a New Website</h2>
            <div class="flex space-x-4">
                <input type="text" id="website-url" placeholder="https://example.com" class="flex-grow p-3 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="website-keyword" placeholder="Twitter keyword (e.g., #example)" class="flex-grow p-3 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addWebsite()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded transition duration-300">Add</button>
            </div>
        </div>

        <!-- Monitored Websites -->
        <div>
            <h2 class="text-2xl font-semibold mb-4">Monitored Services</h2>
            <div id="website-list" class="space-y-4">
                <!-- Website items will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- OIDC and API Configuration ---
        const cognitoDomain = 'https://ap-south-1brnfj8b8w.auth.ap-south-1.amazoncognito.com';
        const userPoolId = 'ap-south-1_bRNFj8B8W';
        const clientId = '4e3el92ks6l1ck8eogckvv0lkn';
        const region = 'ap-south-2'; 
        
        // This should be the URL of the page where this code is running (your S3 static site URL).
        const redirectUri = "http://localhost:8080"; 
        const logoutUri = "http://localhost:8080";

        const apiGatewayEndpoint = 'http://127.0.0.1:3000';
        let idToken = null;

        const cognitoAuthConfig = {
            authority: `https://cognito-idp.${region}.amazonaws.com/${userPoolId}`,
            client_id: clientId,
            redirect_uri: redirectUri,
            response_type: "code",
            scope: "openid email profile", // Ensure these scopes are enabled in your App Client
            post_logout_redirect_uri: logoutUri,
        };
        
        const userManager = new oidc.UserManager(cognitoAuthConfig);

        // --- UI Functions ---
        function showApp(user) {
            idToken = user.id_token;
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            // Display user info
            document.getElementById("email").textContent = user.profile?.email;
            document.getElementById("id-token").textContent = user.id_token;
            
            loadWebsites();
        }

        function showAuth() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // --- Authentication Logic ---
        document.getElementById("signIn").addEventListener("click", () => {
            userManager.signinRedirect();
        });

        document.getElementById("signOut").addEventListener("click", () => {
            // This performs a local signout and then redirects to the Cognito logout endpoint
            userManager.signoutRedirect();
        });

        async function handleAuthCallback() {
            try {
                const user = await userManager.signinCallback();
                if (user) {
                    showApp(user);
                    // Clean the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error("Error handling sign-in callback:", error);
                showAuth();
            }
        }
        
        // --- Main Application Logic on Page Load ---
        async function main() {
            // Check if this is a redirect from the login page
            if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
                await handleAuthCallback();
                return;
            }

            // Check if user is already logged in
            const user = await userManager.getUser();
            if (user && !user.expired) {
                showApp(user);
            } else {
                showAuth();
            }
        }

        main();

        // --- API Functions (unchanged logic, but now uses the new idToken) ---
        async function loadWebsites() {
             if (!idToken) return;
            try {
                const response = await fetch(apiGatewayEndpoint + '/websites', {
                    method: 'GET',
                    headers: { 'Authorization': idToken }
                });
                if (!response.ok) throw new Error('Failed to fetch websites');
                const websites = await response.json();
                const websiteList = document.getElementById('website-list');
                websiteList.innerHTML = ''; 
                websites.forEach(site => {
                    const sentimentScore = parseFloat(site.sentiment_score || 0).toFixed(2);
                    let statusColor = 'text-gray-400';
                    if (site.status === 'UP') statusColor = 'text-green-400';
                    if (site.status === 'DOWN') statusColor = 'text-red-400';
                    
                    let sentimentColor = 'text-gray-400';
                    if (sentimentScore > 0.2) sentimentColor = 'text-green-400';
                    if (sentimentScore < -0.2) sentimentColor = 'text-red-400';

                    const websiteElement = `
                        <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center shadow-md">
                            <div>
                                <p class="font-semibold text-lg">${site.website_url}</p>
                                <p class="text-sm text-gray-400">Twitter Keyword: ${site.twitter_keyword}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${statusColor}">${site.status || 'Checking...'}</p>
                                <p class="font-bold ${sentimentColor}">Sentiment: ${sentimentScore}</p>
                            </div>
                        </div>
                    `;
                    websiteList.innerHTML += websiteElement;
                });

            } catch (error) {
                console.error('Error loading websites:', error);
                alert('Could not load websites.');
            }
        }

        async function addWebsite() {
             if (!idToken) return;
            const url = document.getElementById('website-url').value;
            const keyword = document.getElementById('website-keyword').value;
            if (!url || !keyword) {
                alert('Please enter both a URL and a Twitter keyword.');
                return;
            }

            try {
                const response = await fetch(apiGatewayEndpoint + '/websites', {
                    method: 'POST',
                    headers: {
                        'Authorization': idToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ website_url: url, twitter_keyword: keyword })
                });

                if (!response.ok) throw new Error('Failed to add website');
                document.getElementById('website-url').value = '';
                document.getElementById('website-keyword').value = '';
                loadWebsites();

            } catch (error) {
                console.error('Error adding website:', error);
                alert('Could not add website.');
            }
        }
    </script>
</body>
</html>