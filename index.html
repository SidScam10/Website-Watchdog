<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Watchdog</title>
    <!-- Imports Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Imports OIDC Client library for Cognito authentication -->
    <script src="https://unpkg.com/oidc-client-ts@2.2.0/dist/browser/oidc-client-ts.min.js"></script>
    <!-- Imports the Inter font family -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom style for text in <pre> tags */
        pre {
            white-space: pre-wrap;
            word-break: break-all;
            background-color: #1f2937; /* Darker background for code/tokens */
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Auth Container: Shown when logged out -->
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 text-center bg-gray-800 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6">Website Watchdog</h2>
        <p class="mb-6 text-gray-400">Please sign in to continue to your dashboard.</p>
        <button id="signIn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-300">Sign In</button>
    </div>

    <!-- Main App Container: Shown when logged in -->
    <div id="app-container" class="hidden max-w-4xl mx-auto mt-10 p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Dashboard</h1>
            <button id="signOut" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Logout</button>
        </div>

        <!-- Add Website Form -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Monitor a New Website</h2>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="website-url" placeholder="https://example.com" class="flex-grow p-3 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="website-keyword" placeholder="Twitter keyword (e.g., #example)" class="flex-grow p-3 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addWebsite()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded transition duration-300">Add</button>
            </div>
        </div>

        <!-- Monitored Websites -->
        <div>
            <h2 class="text-2xl font-semibold mb-4">Monitored Services</h2>
            <div id="website-list" class="space-y-4">
                <!-- Website items will be injected here by loadWebsites() -->
            </div>
        </div>
    </div>

    <script>
        // --- OIDC and API Configuration ---
        // These MUST be filled in with your own AWS resource values.
        const cognitoConfig = {
            region : 'ap-south-2',
            userPoolId: 'ap-south-2_bLLgSfyzX', // e.g., us-east-1_xxxxxxxxx
            clientId: '3kvgn6o8b77pajam0mrr8b8fe1', // The App Client ID
            cognitoDomain: 'https://ap-south-2bllgsfyzx.auth.ap-south-2.amazoncognito.com',
            apiGatewayEndpoint: 'http://127.0.0.1:3000', // For local SAM testing
            redirectUri: 'http://localhost:8081', // For local http.server
            logoutUri: 'http://localhost:8081'      // For local http.server
        };
        let idToken = null; // Stores the user's ID token after login

        // Configuration for the oidc-client-ts library
        const authSettings = {
            authority: `https://cognito-idp.${cognitoConfig.userPoolId.split('_')[0]}.amazonaws.com/${cognitoConfig.userPoolId}`,
            client_id: cognitoConfig.clientId,
            redirect_uri: cognitoConfig.redirectUri,
            response_type: "code", // Use Authorization Code flow
            scope: "openid email profile", // The scopes we requested in Cognito
            post_logout_redirect_uri: cognitoConfig.logoutUri,
        };
        
        const userManager = new oidc.UserManager(authSettings);

        // --- UI Functions ---
        // Shows the main app and hides the login button
        function showApp(user) {
            idToken = user.id_token; // Save the token for API calls
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            loadWebsites(); // Load user data
        }

        // Shows the login button and hides the main app
        function showAuth() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // --- Authentication Logic ---
        document.getElementById("signIn").addEventListener("click", () => userManager.signinRedirect());
        document.getElementById("signOut").addEventListener("click", () => userManager.signoutRedirect());

        // Handles the redirect back from Cognito after a successful login
        async function handleAuthCallback() {
            try {
                const user = await userManager.signinCallback();
                if (user) {
                    showApp(user);
                    // Clean the URL (remove the ?code=... part)
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error("Error handling sign-in callback:", error);
                showAuth();
            }
        }
        
        // --- Main Application Logic on Page Load ---
        async function main() {
            // Check if this is a redirect back from Cognito
            if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
                await handleAuthCallback();
                return;
            }
            // Otherwise, check if user is already logged in
            const user = await userManager.getUser();
            if (user && !user.expired) {
                showApp(user);
            } else {
                showAuth(); // Not logged in, show login button
            }
        }
        main(); // Run the main logic when the page loads

        // --- API Functions ---
        
        /**
         * Fetches the list of websites from the API and renders them.
         */
        async function loadWebsites() {
             if (!idToken) return;
            try {
                const response = await fetch(cognitoConfig.apiGatewayEndpoint + '/websites', {
                    method: 'GET',
                    headers: { 'Authorization': idToken } // Send the ID token for auth
                });
                if (!response.ok) throw new Error('Failed to fetch websites');
                
                const websites = await response.json();
                const websiteList = document.getElementById('website-list');
                websiteList.innerHTML = ''; // Clear the list before re-rendering

                if (websites.length === 0) {
                    websiteList.innerHTML = '<p class="text-gray-400 text-center">No websites added yet. Add one above to start monitoring.</p>';
                    return;
                }

                websites.forEach(site => {
                    // --- Status Colors ---
                    const sentimentScore = parseFloat(site.sentiment_score || 0).toFixed(2);
                    let statusColor = 'text-gray-400';
                    if (site.status === 'UP') statusColor = 'text-green-400';
                    if (site.status === 'DOWN') statusColor = 'text-red-400';
                    
                    let sentimentColor = 'text-gray-400';
                    if (sentimentScore > 0.1) sentimentColor = 'text-green-400';
                    if (sentimentScore < -0.1) sentimentColor = 'text-red-400';

                    // --- NEW CHANGE: Build the list of example tweets ---
                    let tweetsHtml = '';
                    // Check if the 'example_tweets' key exists and has items
                    if (site.example_tweets && site.example_tweets.length > 0) {
                        tweetsHtml = '<ul class="mt-3 pt-3 border-t border-gray-700 pl-4 list-disc text-gray-400 text-sm">';
                        tweetsHtml += '<li class="font-semibold text-gray-300 mb-1">Recent Tweets Analyzed:</li>';
                        site.example_tweets.forEach(tweet => {
                            // Truncate long tweets for display
                            const shortTweet = tweet.length > 100 ? tweet.substring(0, 100) + '...' : tweet;
                            tweetsHtml += `<li class="italic ml-4">"${shortTweet}"</li>`;
                        });
                        tweetsHtml += '</ul>';
                    }
                    // --- END OF NEW CHANGE ---

                    // --- Build the final HTML for the card ---
                    const websiteElement = `
                        <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-lg">${site.website_url}</p>
                                    <p class="text-sm text-gray-400">Twitter Keyword: ${site.twitter_keyword}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="font-bold text-lg ${statusColor}">${site.status || 'Checking...'}</p>
                                    <p class="font-semibold ${sentimentColor}">Sentiment: ${sentimentScore}</p>
                                </div>
                            </div>
                            <!-- NEW CHANGE: Inject the tweets HTML here -->
                            ${tweetsHtml}
                        </div>
                    `;
                    websiteList.innerHTML += websiteElement;
                });

            } catch (error) {
                console.error('Error loading websites:', error);
                alert('Could not load websites.');
            }
        }

        /**
         * Sends a new website to the API to be added.
         */
        async function addWebsite() {
             if (!idToken) return;
            const url = document.getElementById('website-url').value;
            const keyword = document.getElementById('website-keyword').value;
            if (!url || !keyword) {
                alert('Please enter both a URL and a Twitter keyword.');
                return;
            }

            try {
                const response = await fetch(cognitoConfig.apiGatewayEndpoint + '/websites', {
                    method: 'POST',
                    headers: {
                        'Authorization': idToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ website_url: url, twitter_keyword: keyword })
                });

                if (!response.ok) throw new Error('Failed to add website');
                document.getElementById('website-url').value = '';
                document.getElementById('website-keyword').value = '';
                loadWebsites(); // Refresh the list

            } catch (error) {
                console.error('Error adding website:', error);
                alert('Could not add website.');
            }
        }
    </script>
</body>
</html>

